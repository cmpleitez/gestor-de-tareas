# Configuración optimizada para Nginx en Laragon
# Ubicación: C:\laragon\etc\nginx\sites-enabled\gestor-de-tareas.conf

server {
    listen 80;
    server_name gestor-de-tareas.test;
    root "C:/laragon/www/gestor-de-tareas/public";
    
    # Configuraciones de rendimiento para prevenir errores 502
    client_max_body_size 256M;
    client_body_timeout 300s;
    client_header_timeout 300s;
    
    # Configuraciones de proxy para PHP-FPM
    location ~ \.php$ {
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        
        # Configuraciones críticas para prevenir 502
        fastcgi_read_timeout 300s;
        fastcgi_send_timeout 300s;
        fastcgi_connect_timeout 60s;
        fastcgi_buffer_size 128k;
        fastcgi_buffers 4 256k;
        fastcgi_busy_buffers_size 256k;
        fastcgi_temp_file_write_size 256k;
        fastcgi_intercept_errors on;
        
        # Configuraciones de memoria
        fastcgi_param PHP_VALUE "memory_limit=1024M\nmax_execution_time=300\nmax_input_time=300";
    }
    
    # Configuraciones para archivos estáticos
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # Configuración principal de Laravel
    location / {
        try_files $uri $uri/ /index.php?$query_string;
        
        # Headers de seguridad
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
    }
    
    # Configuraciones de logging
    access_log "C:/laragon/logs/nginx/gestor-de-tareas.access.log";
    error_log "C:/laragon/logs/nginx/gestor-de-tareas.error.log";
    
    # Configuraciones de compresión
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;
}

# Configuración adicional para PHP-FPM (php-fpm.conf)
# Ubicación: C:\laragon\bin\php\php-8.x.x\php-fpm.conf

[global]
pid = C:/laragon/tmp/php-fpm.pid
error_log = C:/laragon/logs/php-fpm.log
daemonize = no

[www]
user = daemon
group = daemon

# Configuraciones críticas para prevenir 502
listen = 127.0.0.1:9000
listen.owner = daemon
listen.group = daemon
listen.mode = 0660

# Configuraciones de procesos
pm = dynamic
pm.max_children = 50
pm.start_servers = 5
pm.min_spare_servers = 5
pm.max_spare_servers = 35
pm.max_requests = 1000

# Configuraciones de timeouts
request_terminate_timeout = 300s
request_slowlog_timeout = 10s

# Configuraciones de memoria
php_admin_value[memory_limit] = 1024M
php_admin_value[max_execution_time] = 300
php_admin_value[max_input_time] = 300
php_admin_value[post_max_size] = 256M
php_admin_value[upload_max_filesize] = 256M

# Configuraciones de logging
slowlog = C:/laragon/logs/php-fpm-slow.log
php_admin_flag[log_errors] = on
php_admin_value[error_log] = C:/laragon/logs/php-fpm-error.log

# Configuraciones de sesión
php_admin_value[session.gc_maxlifetime] = 1440
php_admin_value[session.cookie_lifetime] = 0

# Configuraciones de base de datos
php_admin_value[default_socket_timeout] = 60
php_admin_value[mysql.connect_timeout] = 60
php_admin_value[mysqlnd.net_read_timeout] = 60 